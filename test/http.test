# encoding: tarantool
print('box.httpd test')

import os, shutil

# TODO: fix out-of-source build
module_path = os.path.join(vardir, "box/http")
app_path = vardir + "/http_test_app"
shutil.rmtree(module_path, True)
shutil.rmtree(app_path, True)
os.makedirs(module_path)
shutil.copy("../src/module/http/lib.so", module_path)
shutil.copy("../src/module/http/client.lua", module_path)
shutil.copy("../src/module/http/server.lua", module_path)
shutil.copy("../src/module/http/codes.lua", module_path)
shutil.copy("../src/module/http/mime_types.lua", module_path)
shutil.copytree("../test/module/http_test_app", app_path)

server.stop()
server.deploy(init_lua="module/http_init.lua")

# http_lib = require('box.http.lib')
# http_client = require('box.http.client')
# http_server = require('box.http.server')

exec admin "lua http_lib.split_url('http://abc')"
exec admin "lua http_lib.split_url('http://abc/')"
exec admin "lua http_lib.split_url('http://abc?')"
exec admin "lua http_lib.split_url('http://abc:')"
exec admin "lua http_lib.split_url('http://abc:123')"
exec admin "lua http_lib.split_url('http://abc:123?')"
exec admin "lua http_lib.split_url('http://abc:123?query')"
exec admin "lua http_lib.split_url('http://domain.subdomain.com:service?query')"
exec admin "lua http_lib.split_url('google.com')"
exec admin "lua http_lib.split_url('google.com?query')"
exec admin "lua http_lib.split_url('google.com/abc?query')"
exec admin "lua http_lib.split_url('https://google.com/abc?query')"
exec admin "lua http_lib.split_url('https://google.com:443/abc?query')"
exec admin "lua http_lib.split_url('https://')"

exec admin "lua http_lib.template(\"<% for i = 1, cnt do %> <%= abc %> <% end %>\", {abc = '1 <3>&\" ', cnt = 3})"
exec admin "lua http_lib.template(\"<% for i = 1, cnt do %> <%= ab %> <% end %>\", {abc = '1 <3>&\" ', cnt = 3})"
exec admin "lua http_lib.template(\"<% ab() %>\", {ab = '1'})"

exec admin "lua dump = function(d, ...) if type(d) ~= 'table' then return \"'\" .. box.cjson.encode(d, ...) .. \"'\" end local o = {} for k, v in pairs(d) do if type(v) ~= 'function' then o[k] = v end end  return \"'\" .. box.cjson.encode(o) .. \"'\" end"
exec admin "lua hdump = function(h) h.server = nil return dump(h) end"

exec admin "lua dump(http_server.parse_request('abc'))"
exec admin 'lua dump(http_server.parse_request("GET / HTTP/1.1\\nHost: s.com\\r\\n\\r\\n"))'
exec admin 'lua dump(http_server.parse_request("GET / HTTP/1.0\\nHost: s.com\\nHost: cde.com"))'
exec admin 'lua dump(http_server.parse_request("GET / HTTP/0.9\\nX-Host: s.com\\r\\n\\r\\nbody text"))'

exec admin "lua dump(http_lib.parse_response('abc'))"
exec admin 'lua dump(http_lib.parse_response("HTTP/1.0 200 Ok\\nHost: s.com\\r\\n\\r\\n"))'
exec admin 'lua dump(http_lib.parse_response("HTTP/1.0 200 Ok\\nHost: s.com\\r\\n\\r\\ntext of body"))'

exec admin 'lua dump(http_client.request("GET", "http://mail.ru/").status)'
exec admin 'lua dump(http_client.get("http://mail.ru/").status)'
exec admin 'lua tonumber(http_client.request("GET", "http://mail.ru/").headers["content-length"]) > 0'
exec admin 'lua http_client.request("GET", "http://mail.ru/").proto[1]'
exec admin 'lua dump(http_client.request("GET", "http://localhost:88/"))'

exec admin 'lua http_client.request("GET", "http://www.yandex.ru/?text=55,37").body:match("<(html)")'

exec admin "lua httpd = http_server.new('127.0.0.1', 12345, { app_dir = 'http_test_app' })"
exec admin "lua type(httpd:route({path = '/abc/:cde/:def', name = 'test'}, function() end))"
exec admin "lua type(httpd:route({path = '/abc'}, function() end))"
exec admin "lua type(httpd:route({path = '/ctxaction'}, 'module.controller#action'))"
exec admin "lua type(httpd:route({path = '/absentaction'}, 'module.controller#absent'))"
exec admin "lua type(httpd:route({path = '/absent'}, 'module.absent#action'))"
exec admin "lua type(httpd:route({path = '/abc/:cde'}, function() end))"
exec admin "lua type(httpd:route({path = '/abc_:cde_def'}, function() end))"
exec admin "lua type(httpd:route({path = '/abc-:cde-def'}, function() end))"
exec admin "lua type(httpd:route({path = '/aba*def'}, function() end))"
exec admin "lua type(httpd:route({path = '/abb*def/cde', name = 'star'}, function() end))"
exec admin "lua type(httpd:route({path = '/abb*def/cde', name = 'star'}, function() end))"
exec admin "lua type(httpd:helper('helper_title', function(self, a) return 'Hello, ' .. a end))"

exec admin "lua httpd:match('GET', '/')"

exec admin "lua dump(httpd:match('GET', '/abc').endpoint.path)"
exec admin "lua dump(httpd:match('GET', '/abc').stash)"

exec admin "lua dump(httpd:match('GET', '/abc/123').endpoint.path)"
exec admin "lua dump(httpd:match('GET', '/abc/123').stash)"

exec admin "lua dump(httpd:match('GET', '/abc/123/122').endpoint.path)"
exec admin "lua dump(httpd:match('GET', '/abc/123/122').stash)"

exec admin "lua dump(httpd:match('GET', '/abc_123-122').endpoint.path)"
exec admin "lua dump(httpd:match('GET', '/abc_123-122').stash)"

exec admin "lua dump(httpd:match('GET', '/abc-123-def').endpoint.path)"
exec admin "lua dump(httpd:match('GET', '/abc-123-def').stash)"

exec admin "lua dump(httpd:match('GET', '/aba-123-dea/1/2/3').endpoint.path)"
exec admin "lua dump(httpd:match('GET', '/aba-123-dea/1/2/3').stash)"

exec admin "lua dump(httpd:match('GET', '/abb-123-dea/1/2/3/cde').endpoint.path)"
exec admin "lua dump(httpd:match('GET', '/abb-123-dea/1/2/3/cde').stash)"

exec admin "lua httpd:url_for('abcdef')"
exec admin "lua httpd:url_for('test')"
exec admin "lua httpd:url_for('test', { cde = 'cde_v', def = 'def_v' })"
exec admin "lua httpd:url_for('star', { def = '/def_v' })"
exec admin "lua httpd:url_for('star', { def = '/def_v' }, { a = 'b', c = 'd' })"

exec admin "lua ep = httpd:route({ path = '/test', file = 'test.html.el' }, function(cx) cx:render({ title = 'title: 123' }) end)"
exec admin "lua httpd.routes[ #httpd.routes ].template"

exec admin "lua type(httpd:start())"

exec admin "lua res = http_client.request('GET', 'http://127.0.0.1:12345/test')"
exec admin "lua res.status"
exec admin "lua res.status == 200"
exec admin "lua res.reason == 'Ok'"
exec admin "lua string.match(res.body, 'title: 123') == 'title: 123'"

exec admin "lua res = http_client.request('GET', 'http://127.0.0.1:12345/test1')"
exec admin "lua res.status == 404"

exec admin "lua res = http_client.request('GET', 'http://127.0.0.1:12345/absent')"
exec admin "lua res.status == 500"
exec admin "lua string.match(res.body, 'load module') == 'load module'"

exec admin "lua res = http_client.request('GET', 'http://127.0.0.1:12345/ctxaction')"
exec admin "lua res.status == 200"
exec admin "lua string.match(res.body, 'Hello, Tarantool') == 'Hello, Tarantool'"
exec admin "lua string.match(res.body, 'action: action') == 'action: action'"
exec admin "lua string.match(res.body, 'controller: module[.]controller') == 'controller: module.controller'"

exec admin "lua res = http_client.request('GET', 'http://127.0.0.1:12345/ctxaction.js')"
exec admin "lua res.status == 200"
exec admin "lua string.match(res.body, 'json template js') == 'json template js'"

exec admin "lua res = http_client.request('GET', 'http://127.0.0.1:12345/ctxaction.jsonaaa')"
exec admin "lua res.status == 500"
exec admin "lua string.match(res.body, 'No such file') == 'No such file'"

exec admin "lua res = http_client.request('GET', 'http://127.0.0.1:12345/hello.html')"
exec admin "lua res.status == 200"
exec admin "lua string.match(res.body, 'static html') == 'static html'"

exec admin "lua res = http_client.request('GET', 'http://127.0.0.1:12345/absentaction')"
exec admin "lua res.status == 500"
exec admin "lua string.match(res.body, 'contain function') == 'contain function'"

exec admin "lua type(httpd:route({path = '/helper', file = 'helper.html.el'}))"
exec admin "lua res = http_client.request('GET', 'http://127.0.0.1:12345/helper')"
exec admin "lua res.status == 200"
exec admin "lua res.reason == 'Ok'"
exec admin "lua string.match(res.body, 'Hello, world') == 'Hello, world'"

exec admin "lua res = http_client.request('GET', 'http://127.0.0.1:12345/helper?abc')"
exec admin "lua res.status == 200"
exec admin "lua res.reason == 'Ok'"
exec admin "lua string.match(res.body, 'Hello, world') == 'Hello, world'"

exec admin "lua type(httpd:route({path = '/die', file = 'helper.html.el'}, function() error(123) end ))"
exec admin "lua res = http_client.request('GET', 'http://127.0.0.1:12345/die')"
exec admin "lua res.status == 500"
exec admin "lua res.reason == 'Internal server error'"

exec admin "lua dump(http_lib.params())"
exec admin "lua dump(http_lib.params(''))"
exec admin "lua dump(http_lib.params('a'))"
exec admin "lua dump(http_lib.params('a=b'))"
exec admin "lua dump(http_lib.params('a=b&b=cde'))"
exec admin "lua dump(http_lib.params('a=b&b=cde&a=1'))"
exec admin "lua dump(http_lib.params('a=b&b=cde&a=1&a=10'))"

exec admin "lua type(httpd:route({method = 'POST', path = '/dit', file = 'helper.html.el'}, function(tx) tx:render({text = 'POST = ' .. tx.req.body}) end ))"
exec admin "lua type(httpd:route({method = 'GET', path = '/dit', file = 'helper.html.el'}, function(tx) tx:render({text = 'GET = ' .. tx.req.body}) end ))"

exec admin "lua res = http_client.request('POST', 'http://127.0.0.1:12345/dit', 'test')"
exec admin "lua res.body == 'POST = test'"

exec admin "lua res = http_client.post('http://127.0.0.1:12345/dit', 'test')"
exec admin "lua res.body == 'POST = test'"

exec admin "lua res = http_client.request('GET', 'http://127.0.0.1:12345/dit')"
exec admin "lua res.body == 'GET = '"

exec admin "lua type(httpd:route({method = 'POST', path = '/gparam' }, function(tx) tx:render({text = 'POST PARAM = ' .. dump( tx.req:post_param() )  }) end ))"

exec admin "lua type(httpd:route({path = '/gparam' }, function(tx) tx:render({text = 'PARAM = ' .. dump( tx.req:query_param() )  }) end ))"

exec admin "lua res = http_client.request('GET', 'http://127.0.0.1:12345/gparam?aaa=12343')"
exec admin "lua res.body == [[PARAM = '{\"aaa\":\"12343\"}']]"

exec admin "lua res = http_client.request('POST', 'http://127.0.0.1:12345/gparam?aaa=12343', '')"
exec admin "lua res.body == [[POST PARAM = '{}']]"
exec admin "lua res = http_client.request('POST', 'http://127.0.0.1:12345/gparam?aaa=12343', 'bbb=4321')"
exec admin "lua res.body == [[POST PARAM = '{\"bbb\":\"4321\"}']]"

exec admin "lua type(httpd:route({path = '/bparam' }, function(tx) tx:render({text = 'PARAM = ' .. dump( tx.req:param() )  }) end ))"
exec admin "lua res = http_client.request('POST', 'http://127.0.0.1:12345/bparam?aaa=12343', 'bbb=4321')"
exec admin "lua res.body == [[PARAM = '{\"bbb\":\"4321\",\"aaa\":\"12343\"}']]"

exec admin "lua type(httpd:route({method = 'GET', path = '/cookie' }, function(tx) tx:cookie({name = 'name', value = 'value' }) tx:cookie({name = 'time', value = 'a ' .. tostring(tx:cookie('time')) }) tx:render({text = 'a ' .. tostring(tx:cookie('time'))  }) end ))"

exec admin "lua res = http_client.request('GET', 'http://127.0.0.1:12345/cookie')"
exec admin "lua dump(res.status)"
exec admin "lua dump(res.body)"
exec admin "lua dump(res.headers['set-cookie'])"

exec admin "lua res = http_client.request('GET', 'http://127.0.0.1:12345/cookie', nil, { headers = { cookie = 'name=ignore; time=123' } })"
exec admin "lua dump(res.status)"
exec admin "lua dump(res.body)"
exec admin "lua hdump(res.headers)"
exec admin "lua dump(res.headers['set-cookie'])"

# exec admin "lua box.fiber.sleep(3600)"
